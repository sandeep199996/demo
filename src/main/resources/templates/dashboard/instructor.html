<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: head}"></head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container mt-4">
    <h2><i class="fas fa-chalkboard-teacher"></i> Instructor Dashboard</h2>
    <p class="text-muted">Welcome back, <span id="instructorName">Instructor</span>!</p>

    <div class="row mt-4">
        <div class="col-md-3 mb-4">
            <div class="card text-white bg-primary">
                <div class="card-body text-center">
                    <h5><i class="fas fa-book"></i> Total Courses</h5>
                    <h2 id="totalCourses">0</h2>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-4">
            <div class="card text-white bg-success">
                <div class="card-body text-center">
                    <h5><i class="fas fa-users"></i> Total Students</h5>
                    <h2 id="totalStudents">0</h2>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-4">
            <div class="card text-white bg-warning">
                <div class="card-body text-center">
                    <h5><i class="fas fa-file-alt"></i> Total Lessons</h5>
                    <h2 id="totalLessons">0</h2>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-4">
            <div class="card text-white bg-info">
                <div class="card-body text-center">
                    <h5><i class="fas fa-chart-line"></i> Avg Progress</h5>
                    <h2 id="avgProgress">0%</h2>
                </div>
            </div>
        </div>
    </div>

    <div class="card mt-4">
        <div class="card-header">
            <h4><i class="fas fa-list"></i> My Courses</h4>
        </div>
        <div class="card-body">
            <div id="coursesContainer">
                <p class="text-center text-muted">Loading...</p>
            </div>
        </div>
    </div>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>

<script>
    async function loadDashboard() {
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        if (!token) {
            window.location.href = '/login';
            return;
        }

        document.getElementById('instructorName').textContent = user.email || 'Instructor';

        try {
            const analyticsResponse = await fetch('/api/analytics/instructor/my-analytics', {
                headers: {'Authorization': `Bearer ${token}`}
            });

            if (analyticsResponse.ok) {
                const analytics = await analyticsResponse.json();
                document.getElementById('totalCourses').textContent = analytics.totalCourses || 0;
                document.getElementById('totalStudents').textContent = analytics.totalStudents || 0;
                document.getElementById('totalLessons').textContent = analytics.totalLessons || 0;
                document.getElementById('avgProgress').textContent = Math.round(analytics.averageStudentProgress || 0) + '%';
            }

            const coursesResponse = await fetch('/api/courses/instructor/my-courses', {
                headers: {'Authorization': `Bearer ${token}`}
            });

            if (coursesResponse.ok) {
                const courses = await coursesResponse.json();
                displayCourses(courses);
            } else {
                document.getElementById('coursesContainer').innerHTML =
                    '<p class="text-muted">No courses created yet.</p>';
            }

        } catch (error) {
            console.error('Error:', error);
            document.getElementById('coursesContainer').innerHTML =
                '<p class="text-danger">Error loading dashboard data</p>';
        }
    }

    function displayCourses(courses) {
        const container = document.getElementById('coursesContainer');

        if (!courses || courses.length === 0) {
            container.innerHTML = '<p class="text-muted">No courses created yet.</p>';
            return;
        }

        let html = '<div class="row">';

        courses.forEach(course => {
            const status = course.published ?
                '<span class="badge bg-success">Published</span>' :
                '<span class="badge bg-secondary">Draft</span>';

            html += `<div class="col-md-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">${course.title}</h5>
                            <p class="card-text text-muted">${(course.description || '').substring(0, 100)}...</p>
                            <p>${status}</p>
                            <p><small><i class="fas fa-users"></i> ${course.enrollmentCount || 0} students</small></p>
                        </div>
                    </div>
                </div>`;
        });

        html += '</div>';
        container.innerHTML = html;
    }

    document.addEventListener('DOMContentLoaded', loadDashboard);
</script>
</body>
</html>
